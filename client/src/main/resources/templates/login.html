<!DOCTYPE html>
<html th:dir="#{direction}" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="#{siteName}"></title>
    <link rel="icon" type="image/ico" th:href="@{/images/favicon.png}"/>
    <link rel="stylesheet" type="text/css" th:href="#{direction} +'/bootstrap/dist/css/bootstrap.min.css'"/>
    <link rel="stylesheet" type="text/css" th:href="#{direction} +'/font-awesome/css/font-awesome.min.css'"/>
    <link rel="stylesheet" type="text/css" th:href="#{direction} +'/animate.css/animate.min.css'"/>
    <link rel="stylesheet" type="text/css" th:href="#{direction} +'/pnotify/dist/pnotify.css'">
    <link rel="stylesheet" type="text/css" th:href="#{direction} +'/pnotify/dist/pnotify.buttons.css'">
    <link rel="stylesheet" type="text/css" th:href="#{direction} +'/pnotify/dist/pnotify.nonblock.css'">
    <link rel="stylesheet" type="text/css" th:href="#{direction} +'/select2/dist/css/select2.min.css'">
    <link rel="stylesheet" type="text/css" th:href="@{/css/lib/select2-bootstrap.css}"/>
    <link rel="stylesheet" type="text/css" th:href="#{direction} +'/build/css/custom.css'"/>
    <style>
        .login_content form input {
            margin: 0!important;
        }
        .login_content .form-group {
            margin: 0 0 20px!important;
        }
        .form-group {
            margin-right: auto!important;
            margin-left: auto!important;
            width: 100% !important;
        }
        .form-control, .form-group {
            border-radius: 0 !important;
            width: 100% !important;
        }
        .bad input, .bad select, .bad textarea {
            border: 1px solid #CE5454!important;
            -webkit-box-shadow: 0 0 4px -2px #CE5454!important;
            box-shadow: 0 0 4px -2px #CE5454!important;
        }
        label, input, input[placeholder] {
            font-size: 12px !important;
        }

        .btn {
            margin-right: 0;
        }

        .alert {
            padding: 10px;
        }
        .form-control-feedback.right {
            margin-top: 5px;
        }
        span .select2-selection {
            text-align: left;
        }
        .select2-container--bootstrap .select2-selection--single,.select2-search__field {
            border-radius: 0 !important;
        }

        .select2-container--bootstrap .select2-selection--single .select2-selection__arrow {
            border-radius: 0 !important; /* Remove border-radius for arrow */
        }

        .select2-container--bootstrap .select2-selection--single:focus {
            outline: none;
        }
        .select2-container--bootstrap .select2-selection__arrow {
            display: none; /* Hide the arrow icon */
        }
        .select2-container--bootstrap .select2-selection__clear{
            margin-right: 20px;
        }
        .select2-container--bootstrap .select2-selection {
            color: rgb(108, 117, 122) !important;
            font-size: 12px!important;
        }
    </style>
    <script type="text/javascript" th:src="'/js/messages/messages.' + #{locale} + '.js'" ></script>
    <script type="text/javascript" th:src="#{direction} +'/jquery/dist/jquery.min.js'"></script>
    <script type="text/javascript" th:src="#{direction} +'/pnotify/dist/pnotify.js'"></script>
    <script type="text/javascript" th:src="#{direction} +'/pnotify/dist/pnotify.buttons.js'"></script>
    <script type="text/javascript" th:src="#{direction} +'/pnotify/dist/pnotify.nonblock.js'"></script>
    <script type="text/javascript" th:src="#{direction} +'/select2/dist/js/select2.full.min.js'"></script>
    <script type="text/javascript" th:src="@{/js/lib/jquery.validate.min.js}" ></script>
    <script type="text/javascript" th:src="#{direction} +'/bootstrap/dist/js/bootstrap.bundle.min.js'"></script>
    <script type="text/javascript" th:src="#{direction} +'/build/js/custom.min.js'"></script>
</head>
<body class="login" th:dir="#{direction}">
<div>
    <a class="hiddenanchor" id="signup"></a>
    <a class="hiddenanchor" id="signin"></a>
    <a class="hiddenanchor" id="send_otp"></a>

    <div class="login_wrapper">
        <div class="animate form login_form">
            <section class="login_content">
                <form id="login-form" th:action="@{/login}" method="POST" class="form-horizontal">
                    <h1 th:text="#{login} + ' ' + #{form}"></h1>

                    <div class="row">
                        <div class="col-xs-12 form-group">
                            <div class='alert alert-danger' th:if="${errorMsg != null && errorMsg!='invalidSession'}">
                                <button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;
                                </button>
                                <p th:text="#{${errorMsg}}"></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="text" class="form-control" th:placeholder="#{usernameOrEmail}" name="login" autofocus
                               tabindex="1">
                        <span class="fa fa-user form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="password" class="form-control" th:placeholder="#{password}" name="password"
                               tabindex="2">
                        <span class="fa fa-eye-slash toggle-password form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 form-group">
                            <button tabindex="3" type="submit" class="btn btn-secondary" style="width: 100%;" th:value="#{enter}">Enter</button>
                        </div>
                    </div>
                    <div class="clearfix"></div>

                    <div class="separator">
                        <div class="row">
                            <div class="col-xs-12">
                                <p class="change_link">
                                    <th:block th:text="#{lostYourPass}"></th:block>
                                    <a class="send_otp" href="#send_otp" th:text="#{send} + ' OTP'">Send OTP</a>
                                </p>
                            </div>
                            <div class="col-xs-12">
                                <p class="change_link">New to site?
                                    <a href="#signup" class="to_register"> Create Account </a>
                                </p>
                            </div>
                        </div>

                        <div class="clearfix"></div>
                        <br/>

                        <div>
                            <h2><img th:src="@{/images/favicon.png}" style="width: 40px">
                                <th:block th:text="#{siteName}"></th:block>
                            </h2>
                            <p>
                                <th:block th:text="#{AllRightReserved}"></th:block>
                                <th:block th:text="#{siteName}"></th:block>
                                <th:block th:text="#{forCompanyAt}"></th:block>
                            </p>
                        </div>
                    </div>
                </form>
            </section>
        </div>
        <div class="animate form send_otp_form">
            <section class="login_content">
                <form id="send_otp-form" th:action="@{/send-OTP}" method="POST" class="form-horizontal">
                    <h1 th:text="#{send} + ' OTP'"></h1>

                    <div class="row">
                        <div class="col-xs-12 form-group">
                            <div class='alert alert-danger' th:if="${errorMsg != null && errorMsg!='invalidSession'}">
                                <button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;
                                </button>
                                <p th:text="#{${errorMsg}}"></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="text" class="form-control" th:placeholder="#{email}" name="email" autofocus tabindex="4">
                        <span class="fa fa-envelope form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <button tabindex="5" type="submit" class="btn btn-secondary" style="width: 100%;" th:value="#{enter}">Enter</button>
                    </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="separator">
                        <div class="row">
                            <div class="col-xs-12">
                                <p class="change_link">Remember the password?
                                    <a href="#signin" class="to_register" th:text="#{login}">Log in</a>
                                </p>
                            </div>
                            <div class="col-xs-12">
                                <p class="change_link">New to site?&nbsp;
                                    <a href="#signup" class="to_register" th:text="#{createAccount}">Create Account</a>
                                </p>
                            </div>
                        </div>

                        <div class="clearfix"></div>
                        <br/>

                        <div>
                            <h2><i class="fa fa-eye" style="width: 50px"></i>
                                <th:block th:text="#{siteName}"></th:block>
                            </h2>
                            <p>
                                <th:block th:text="#{AllRightReserved}"></th:block>
                                <th:block th:text="#{siteName}"></th:block>
                                <th:block th:text="#{forCompanyAt}"></th:block>
                            </p>
                        </div>
                    </div>
                </form>
            </section>
        </div>
        <div id="register" class="animate form registration_form">
            <section class="login_content">
                <form id="register-form">
                    <h1 th:text="#{createAccount}">Create Account</h1>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <div class='alert alert-danger' th:if="${errorMsg != null && errorMsg!='invalidSession'}">
                            <button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>
                            <p th:text="#{${errorMsg}}"></p>
                        </div>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="text" class="form-control" th:placeholder="#{userName}" id="userName"
                               name="userName" autofocus
                               tabindex="6">
                        <span class="fa fa-user form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="email" class="form-control" th:placeholder="#{email}" id="email"
                               name="email"
                               tabindex="7">
                        <span class="fa fa-envelope form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="password" class="form-control" th:placeholder="#{password}" id="password"
                               name="password" tabindex="8">
                        <span class="fa fa-eye-slash toggle-password form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="password" class="form-control" th:placeholder="#{repeatPassword}"
                               id="repeatPassword" name="repeatPassword" tabindex="9">
                        <span class="fa fa-eye-slash toggle-password form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="text" class="form-control" th:placeholder="#{name}" id="firstName" name="firstName"
                               tabindex="10">
                        <span class="fa fa-pencil form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="text" class="form-control" th:placeholder="#{lastName}" id="lastName"
                               name="lastName" tabindex="11">
                        <span class="fa fa-pencil form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <th:block th:replace="fragments/select2 :: select2('12', #{country}, 'country', 'api/v1/country/findAllSelect','{name:params.term}',false, null)"></th:block>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <input type="text" class="form-control" th:placeholder="#{referralCode}" id="referralCode"
                               th:value="${referralCode ?: ''}" name="referralCode" tabindex="13">
                        <span class="fa fa-user form-control-feedback right" aria-hidden="true"></span>
                    </div>
                    </div>
                    <div class="row">
                    <div class="col-xs-12 form-group">
                        <button tabindex="14" type="submit" class="btn btn-secondary" style="width: 100%;" th:value="#{register}">Register</button>
                    </div>
                    </div>
                    <div class="clearfix"></div>

                    <div class="separator">
                        <div class="row">
                            <div class="col-xs-12">
                                <p class="change_link">Already a member ?
                                    <a href="#signin" class="to_register" th:text="#{login}">Log in</a>
                                </p>
                            </div>
                        </div>

                        <div class="clearfix"></div>
                        <br/>

                        <div>
                            <h2><i class="fa fa-eye" style="width: 50px"></i>
                                <th:block th:text="#{siteName}"></th:block>
                            </h2>
                            <p>
                                <th:block th:text="#{AllRightReserved}"/>
                                <th:block th:text="#{siteName}"/>
                                <th:block th:text="#{forCompanyAt}"/>
                            </p>
                        </div>
                    </div>
                </form>
            </section>
        </div>
    </div>
</div>


<script type="text/javascript">
    if (!String.prototype.format) {
        String.prototype.format = function () {
            var args = arguments;
            return this.replace(/{(\d+)}/g, function (match, number) {
                return typeof args[number] != 'undefined'
                    ? args[number]
                    : match
                    ;
            });
        };
    }

    $(function () {
        $(".toggle-password").click(function() {
            $(this).toggleClass("fa-eye fa-eye-slash");
            var input = $(this).prev('input');
            if (input.attr("type") == "password") {
                input.attr("type", "text");
            } else {
                input.attr("type", "password");
            }
        });

        $('#login-form').validate({
            rules: {
                login: "required",
                password: "required"
            },
            messages: {
                login: resources.pleaseEnter.format(resources.usernameOrEmail),
                password: resources.pleaseEnter.format(resources.password)
            },
            highlight: function (element) {
                $(element).addClass('is-invalid').closest('div').addClass('bad');
            },
            unhighlight: function (element) {
                $(element).removeClass('is-invalid').closest('div').removeClass('bad');
            },
            errorElement: 'span',
            errorClass: 'invalid-feedback',
            errorPlacement: function (error, element) {
                error.insertAfter(element);
            },
            submitHandler: function (form) {
                form.submit();
            }
        });
        $('#send_otp-form').validate({
            rules: {
                email: {
                    required: true,
                    email: true
                }
            },
            messages: {
                email: {
                    required: resources.pleaseEnter.format(resources.email),
                    email: resources.invalidFormat.format(resources.email)
                }
            },
            highlight: function (element) {
                $(element).addClass('is-invalid').closest('div').addClass('bad');
            },
            unhighlight: function (element) {
                $(element).removeClass('is-invalid').closest('div').removeClass('bad');
            },
            errorElement: 'span',
            errorClass: 'invalid-feedback',
            errorPlacement: function (error, element) {
                error.insertAfter(element);
            },
            submitHandler: function (form) {
                form.submit();
            }
        });

        $('#register-form').validate({
            ignore: '.skip',
            rules: {
                userName: "required",
                email: {
                    required: true,
                    email: true
                },
                firstName: "required",
                lastName: "required",
                countrySelect2: "required",
                referralCode: "required",
                password: {
                    required: true,
                    minlength: 5
                },
                repeatPassword: {
                    required: true,
                    minlength: 5,
                    equalTo: "#password"
                },
            },
            messages: {
                userName: resources.pleaseEnter.format(resources.userName),
                email: {
                    required: resources.pleaseEnter.format(resources.email),
                    email: resources.invalidFormat.format(resources.email)
                },
                firstName: resources.pleaseEnter.format(resources.name),
                lastName: resources.pleaseEnter.format(resources.lastName),
                countrySelect2: resources.pleaseSelect.format(resources.country),
                referralCode: resources.pleaseEnter.format(resources.referralCode),
                password: {
                    required: resources.pleaseEnter.format(resources.password),
                    minlength: resources.mustBeMoreThan.format(resources.password, 5, resources.character)
                },
                repeatPassword: {
                    required: resources.pleaseEnter.format(resources.repeatPassword),
                    minlength: resources.mustBeMoreThan.format(resources.password, 5, resources.character),
                    equalTo: resources.confirmPasswordDoesNotMach
                }
            },
            highlight: function (element) {
                $(element).addClass('is-invalid').closest('div').addClass('bad');
            },
            unhighlight: function (element) {
                $(element).removeClass('is-invalid').closest('div').removeClass('bad');
            },
            errorElement: 'span',
            errorClass: 'invalid-feedback',
            errorPlacement: function (error, element) {
                if (element.hasClass('select2-hidden-accessible')) {
                    element.parent().append(error);
                } else {
                    error.insertAfter(element);
                }
            },
            submitHandler: function (form) {
                $.ajax({
                    type: "POST",
                    url: "/api/v1/user/register",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify({country:{id: $("#countrySelect2").val()}, userName:$("#userName").val(),email:$("#email").val(), password:$("#password").val(),firstName: $("#firstName").val(),lastName: $("#lastName").val(),referralCode: $("#referralCode").val() }),
                    success: function (data) {
                        if (data.error == null) {
                            clearAll();
                            new PNotify({
                                title: 'Success',
                                text: 'your information successfully registered.',
                                type: 'success',
                                styling: 'bootstrap3'
                            });
                            window.location.href = "#signin";
                        } else {
                            new PNotify({
                                title: 'Oh No!',
                                text: data.error,
                                type: 'error',
                                hide: false,
                                styling: 'bootstrap3'
                            });
                        }
                    },
                    error: function (header, status, error) {
                        if(isNullOrEmpty(get(() => header.responseJSON)))
                            new PNotify({
                                title: 'Oh No!',
                                text: 'ajax answer post returned error: ' + error.responseText,
                                type: 'error',
                                hide: false,
                                styling: 'bootstrap3'
                            });
                        else new PNotify({
                            title: 'Oh No!',
                            text: header.responseJSON.error + ' (' + header.responseJSON.status + ') <br>' + header.responseJSON.message,
                            type: 'error',
                            hide: false,
                            styling: 'bootstrap3'
                        });
                    }
                });
            }
        });
    });

    function isNullOrEmpty(param) {
        if (param == null)
            return true;
        if (param == "null")
            return true;
        if (param == undefined)
            return true;
        if (param == "undefined")
            return true;
        if ((param + "").trim() == "")
            return true;
        return false;
    }

    function flattenObject(obj, prefix = '') {
        const result = {};
        for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
                const value = obj[key];
                const newKey = prefix ? `${prefix}.${key}` : key;
                if (value && typeof value === 'object' && !Array.isArray(value)) {
                    Object.assign(result, flattenObject(value, newKey));
                } else if (!isNullOrEmpty(value)) {
                    // Only include non-null values
                    result[newKey] = value;
                }
            }
        }
        return result;
    }
    function jsonToUrlSearchParams(json) {
        const flattened = flattenObject(json);
        const params = new URLSearchParams();
        for (const key in flattened) {
            if (flattened.hasOwnProperty(key)) {
                params.append(key, flattened[key]);
            }
        }
        return params.toString();
    }
    function clearAll(){
        $('form').each(function (index, frm) {
            frm.reset();
        });
        $('form input:hidden:not(#myModal form input:hidden)').val('');
        $("select.select2-hidden-accessible").val('').trigger('change');
    }
    function get(lambdaExpr, defaultValue) {// () => supplier expr
        try {
            return lambdaExpr();
        } catch (e) {
            return isNullOrEmpty(defaultValue) ? '' : defaultValue;
        }
    }
</script>
</body>
</html>